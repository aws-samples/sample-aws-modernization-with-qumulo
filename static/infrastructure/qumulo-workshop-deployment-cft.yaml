# MIT No Attribution

# Copyright Amazon.com, Inc., Qumulo or its affiliates. All Rights Reserved.

# Permission is hereby granted, free of charge, to any person obtaining a copy of
# this software and associated documentation files (the "Software"), to deal in
# the Software without restriction, including without limitation the rights to
# use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
# the Software, and to permit persons to whom the Software is furnished to do so.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
# FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
# COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
# IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
# CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
AWSTemplateFormatVersion: '2010-09-09'
Description: Qumulo Workshop Environment Setup with Initial Cluster Deployment via Terraform

Parameters:
  QumuloAccountId:
    Type: String
    Description: Qumulo account ID containing the Lambda function
    Default: "026847022493"
  
  QumuloLambdaFunctionName:
    Type: String
    Description: Name of the Lambda function in Qumulo account
    Default: "workshop_distribution"
  
  QumuloExternalId:
    Type: String
    Description: External ID for secure Lambda invocation
    Default: "0aGc1269bB5vEYxdzbKtFyijQn6RZ6jHzFvapWll"
    NoEcho: true

  QumuloEnvironmentPassword:
    Type: String
    Default: "!Qumulo123"
    Description: "Administrator password for Qumulo Workshop Environment"
    NoEcho: true
    MinLength: 8
    MaxLength: 64

Resources:

  QumuloVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: qumulo-workshop-vpc

  VPCFlowLogsKmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS key for encrypting VPC flow logs
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowAccountUse
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"

          # Allow CloudWatch Logs service to encrypt with this key
          - Sid: AllowCloudWatchLogsUseOfTheKey
            Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:CreateGrant
              - kms:DescribeKey
            Resource: "*"
            Condition:
              ArnLike:
                kms:EncryptionContext:aws:logs:arn: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*"


  # CloudWatch Logs log group for VPC Flow Logs (now encrypted)
  VPCFlowLogsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vpc/flow-logs/${QumuloVPC}"
      RetentionInDays: 14
      KmsKeyId: !GetAtt VPCFlowLogsKmsKey.Arn

  # IAM role for VPC Flow Logs, scoped to this log group (fixes W11)
  VPCFlowLogsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: vpc-flow-logs.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: VPCFlowLogsToCloudWatch
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/vpc/flow-logs/${QumuloVPC}:*"
      Tags:
        - Key: Name
          Value: qumulo-vpc-flowlogs-role

  # VPC Flow Log
  QumuloVPCFlowLog:
    Type: AWS::EC2::FlowLog
    Properties:
      ResourceId: !Ref QumuloVPC
      ResourceType: VPC
      TrafficType: ALL
      LogDestinationType: cloud-watch-logs
      LogGroupName: !Ref VPCFlowLogsLogGroup
      DeliverLogsPermissionArn: !GetAtt VPCFlowLogsRole.Arn
      MaxAggregationInterval: 600
      Tags:
        - Key: Name
          Value: qumulo-vpc-flowlog

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: qumulo-workshop-igw

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref QumuloVPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref QumuloVPC
      CidrBlock: 10.0.0.0/20
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: qumulo-workshop-subnet-public1

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref QumuloVPC
      CidrBlock: 10.0.16.0/20
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: qumulo-workshop-subnet-public2

  PublicSubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref QumuloVPC
      CidrBlock: 10.0.32.0/20
      AvailabilityZone: !Select [2, !GetAZs '']
      Tags:
        - Key: Name
          Value: qumulo-workshop-subnet-public3

  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref QumuloVPC
      CidrBlock: 10.0.128.0/20
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: qumulo-workshop-subnet-private1

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref QumuloVPC
      CidrBlock: 10.0.144.0/20
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: qumulo-workshop-subnet-private2

  PrivateSubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref QumuloVPC
      CidrBlock: 10.0.160.0/20
      AvailabilityZone: !Select [2, !GetAZs '']
      Tags:
        - Key: Name
          Value: qumulo-workshop-subnet-private3


  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref QumuloVPC
      Tags:
        - Key: Name
          Value: qumulo-workshop-rtb-public

  PublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # Associate public subnets with public route table
  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetCRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetC
      RouteTableId: !Ref PublicRouteTable

  EIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: qumulo-workshop-eip

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIP.AllocationId
      SubnetId: !Ref PublicSubnetA
      Tags:
        - Key: Name
          Value: qumulo-workshop-nat-public1

  PrivateRouteTableA:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref QumuloVPC
      Tags:
        - Key: Name
          Value: qumulo-workshop-rtb-private1

  PrivateRouteA:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateRouteTableB:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref QumuloVPC
      Tags:
        - Key: Name
          Value: qumulo-workshop-rtb-private2

  PrivateRouteB:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateRouteTableC:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref QumuloVPC
      Tags:
        - Key: Name
          Value: qumulo-workshop-rtb-private3

  PrivateRouteC:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableC
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  # Associate private subnets with their route tables
  PrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTableA

  PrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTableB

  PrivateSubnetCRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetC
      RouteTableId: !Ref PrivateRouteTableC

  VPCEndpointS3:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref QumuloVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.s3"
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateRouteTableA
        - !Ref PrivateRouteTableB
        - !Ref PrivateRouteTableC
      Tags:
        - Key: Name
          Value: qumulo-workshop-vpce-s3

  # # SSM VPC Endpoints
  # SSMVPCEndpointSecurityGroup:
  #   Type: AWS::EC2::SecurityGroup
  #   Properties:
  #     GroupDescription: Security group for SSM VPC endpoints
  #     VpcId: !Ref QumuloVPC

  #     SecurityGroupIngress:
  #       - IpProtocol: tcp
  #         FromPort: 443
  #         ToPort: 443
  #         SourceSecurityGroupId: !Ref DefaultInstanceSecurityGroup
  #         Description: Allow HTTPS from workshop instances to SSM VPC endpoints

  #     # Egress restricted to HTTPS instead of all protocols / all ports
  #     SecurityGroupEgress:
  #       - IpProtocol: tcp
  #         FromPort: 443
  #         ToPort: 443
  #         CidrIp: 0.0.0.0/0
  #         Description: Allow HTTPS egress to the internet for updates and downloads

  #     Tags:
  #       - Key: Name
  #         Value: ssm-vpc-endpoint-sg



  # VPCEndpointSSM:
  #   Type: AWS::EC2::VPCEndpoint
  #   Properties:
  #     VpcId: !Ref QumuloVPC
  #     ServiceName: !Sub "com.amazonaws.${AWS::Region}.ssm"
  #     VpcEndpointType: Interface
  #     SubnetIds:
  #       - !Ref PrivateSubnetA
  #       - !Ref PrivateSubnetB
  #       - !Ref PrivateSubnetC
  #     SecurityGroupIds:
  #       - !Ref SSMVPCEndpointSecurityGroup
  #     PolicyDocument:
  #       Statement:
  #         - Effect: Allow
  #           Principal: '*'
  #           Action:
  #             - ssm:*
  #           Resource: '*'
  #     Tags:
  #       - Key: Name
  #         Value: qumulo-workshop-vpce-ssm

  # VPCEndpointSSMMessages:
  #   Type: AWS::EC2::VPCEndpoint
  #   Properties:
  #     VpcId: !Ref QumuloVPC
  #     ServiceName: !Sub "com.amazonaws.${AWS::Region}.ssmmessages"
  #     VpcEndpointType: Interface
  #     SubnetIds:
  #       - !Ref PrivateSubnetA
  #       - !Ref PrivateSubnetB
  #       - !Ref PrivateSubnetC
  #     SecurityGroupIds:
  #       - !Ref SSMVPCEndpointSecurityGroup
  #     Tags:
  #       - Key: Name
  #         Value: qumulo-workshop-vpce-ssmmessages

  # VPCEndpointEC2Messages:
  #   Type: AWS::EC2::VPCEndpoint
  #   Properties:
  #     VpcId: !Ref QumuloVPC
  #     ServiceName: !Sub "com.amazonaws.${AWS::Region}.ec2messages"
  #     VpcEndpointType: Interface
  #     SubnetIds:
  #       - !Ref PrivateSubnetA
  #       - !Ref PrivateSubnetB
  #       - !Ref PrivateSubnetC
  #     SecurityGroupIds:
  #       - !Ref SSMVPCEndpointSecurityGroup
  #     Tags:
  #      - Key: Name
  #        Value: qumulo-workshop-vpce-ec2messages

  # New EC2 KeyPair resource
  QumuloWorkshopKeyPair:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyName: qumulo-workshop-keypair
      Tags:
        - Key: Name
          Value: qumulo-workshop-keypair


  EC2SSMRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole

      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore

      Policies:
        - PolicyName: QumuloWorkshopPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:

              # ------------------------------------------------------------------
              # Workshop: utility bucket access (scoped to this bucket)
              # Used by setup-workshop-environment.sh to read Qumulo version, etc.
              # ------------------------------------------------------------------
              - Effect: Allow
                Action:
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                  - s3:GetBucketVersioning
                  - s3:GetObject
                  - s3:ListBucket
                  - s3:ListBucketVersions
                Resource:
                  - !Sub "arn:aws:s3:::${WorkshopUtilityBucket}"
                  - !Sub "arn:aws:s3:::${WorkshopUtilityBucket}/*"

              # ------------------------------------------------------------------
              # Workshop: SSM parameter access (stack + keypair)
              # /${StackName}/* for environment; /ec2/keypair/* for SSH private key
              # ------------------------------------------------------------------
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                Resource:
                  - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/*"
                  - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/ec2/keypair/*"

              # ------------------------------------------------------------------
              # S3 - Qumulo/QPS buckets (scoped to Qumulo namespaces)
              # ------------------------------------------------------------------
              - Effect: Allow
                Action:
                  - s3:CreateBucket
                  - s3:DeleteBucket
                  - s3:DeleteBucketPolicy
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                  - s3:GetAccelerateConfiguration
                  - s3:GetBucketAcl
                  - s3:GetBucketCORS
                  - s3:GetBucketLocation
                  - s3:GetBucketLogging
                  - s3:GetBucketObjectLockConfiguration
                  - s3:GetBucketPolicy
                  - s3:GetBucketPublicAccessBlock
                  - s3:GetBucketRequestPayment
                  - s3:GetBucketTagging
                  - s3:GetBucketVersioning
                  - s3:GetBucketWebsite
                  - s3:GetEncryptionConfiguration
                  - s3:GetLifecycleConfiguration
                  - s3:GetObject
                  - s3:GetObjectTagging
                  - s3:GetObjectVersion
                  - s3:GetReplicationConfiguration
                  - s3:ListBucket
                  - s3:ListBucketVersions
                  - s3:PutBucketLogging
                  - s3:PutBucketPolicy
                  - s3:PutBucketPublicAccessBlock
                  - s3:PutBucketTagging
                  - s3:PutBucketVersioning
                  - s3:PutEncryptionConfiguration
                  - s3:PutLifecycleConfiguration
                  - s3:PutObject
                Resource:
                  - arn:aws:s3:::*qumulo*
                  - arn:aws:s3:::*qumulo*/*
                  - arn:aws:s3:::*qps*
                  - arn:aws:s3:::*qps*/*

              # ------------------------------------------------------------------
              # SSM Parameter Store - Qumulo namespace
              # ------------------------------------------------------------------
              - Effect: Allow
                Action:
                  - ssm:AddTagsToResource
                  - ssm:DeleteParameter
                  - ssm:GetParameter
                  - ssm:GetParameterHistory
                  - ssm:GetParameters
                  - ssm:ListTagsForResource
                  - ssm:PutParameter
                  - ssm:RemoveTagsFromResource
                Resource:
                  - arn:aws:ssm:*:*:parameter/qumulo/*

              # ------------------------------------------------------------------
              # SSM SendCommand - resource scoped to AWS documents and instances
              # needed for automation scripts
              # ------------------------------------------------------------------
              - Effect: Allow
                Action:
                  - ssm:CancelCommand
                  - ssm:GetCommandInvocation
                  - ssm:ListCommandInvocations
                  - ssm:ListCommands
                  - ssm:SendCommand
                Resource:
                  - !Sub "arn:aws:ssm:${AWS::Region}::document/AWS-*"
                  - !Sub "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:instance/*"

              # ------------------------------------------------------------------
              # Secrets Manager - Qumulo secrets
              # ------------------------------------------------------------------
              - Effect: Allow
                Action:
                  - secretsmanager:CreateSecret
                  - secretsmanager:DeleteResourcePolicy
                  - secretsmanager:DeleteSecret
                  - secretsmanager:DescribeSecret
                  - secretsmanager:GetResourcePolicy
                  - secretsmanager:GetSecretValue
                  - secretsmanager:PutResourcePolicy
                  - secretsmanager:PutSecretValue
                  - secretsmanager:RotateSecret
                  - secretsmanager:TagResource
                  - secretsmanager:UntagResource
                  - secretsmanager:UpdateSecret
                  - secretsmanager:UpdateSecretVersionStage
                Resource:
                  - arn:aws:secretsmanager:*:*:secret:/qumulo/*
                  - arn:aws:secretsmanager:*:*:secret:qumulo-*

              # ------------------------------------------------------------------
              # Route53 - DNS management (scoped to hosted zones)
              # ------------------------------------------------------------------
              - Effect: Allow
                Action:
                  - route53:ChangeResourceRecordSets
                  - route53:ChangeTagsForResource
                  - route53:CreateHostedZone
                  - route53:DeleteHostedZone
                  - route53:GetChange
                  - route53:GetHostedZone
                  - route53:ListHostedZones
                  - route53:ListHostedZonesByName
                  - route53:ListResourceRecordSets
                  - route53:ListTagsForResource
                  - route53:UpdateHostedZoneComment
                Resource:
                  - arn:aws:route53:::hostedzone/*
                  - arn:aws:route53:::change/*

              # ------------------------------------------------------------------
              # IAM PassRole - scoped to Qumulo-created roles ONLY
              # required for Terraform to create
              # instance profiles. Scoped to avoid cfn-nag F38 warning.
              # ------------------------------------------------------------------
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource:
                  - !Sub "arn:aws:iam::${AWS::AccountId}:role/qum-*-qumulo-cluster"
                  - !Sub "arn:aws:iam::${AWS::AccountId}:role/qum-*-qumulo-provisioner"
                Condition:
                  StringEquals:
                    iam:PassedToService:
                      - ec2.amazonaws.com

              # ------------------------------------------------------------------
              # Core permissions with wildcard resources
              # Includes: EC2, ELB, IAM (except PassRole), CloudWatch, Route53,
              #           Resource Groups, KMS, STS, CloudFormation, and Tags
              # ------------------------------------------------------------------
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStackResources
                  - cloudformation:DescribeStacks
                  - ec2:AllocateAddress
                  - ec2:AssociateAddress
                  - ec2:AttachNetworkInterface
                  - ec2:AttachVolume
                  - ec2:AuthorizeSecurityGroupEgress
                  - ec2:AuthorizeSecurityGroupIngress
                  - ec2:CreateNetworkInterface
                  - ec2:CreatePlacementGroup
                  - ec2:CreateSecurityGroup
                  - ec2:CreateTags
                  - ec2:CreateVolume
                  - ec2:DeleteNetworkInterface
                  - ec2:DeletePlacementGroup
                  - ec2:DeleteSecurityGroup
                  - ec2:DeleteTags
                  - ec2:DeleteVolume
                  - ec2:DescribeAccountAttributes
                  - ec2:DescribeAddresses
                  - ec2:DescribeAvailabilityZones
                  - ec2:DescribeImages
                  - ec2:DescribeInstanceAttribute
                  - ec2:DescribeInstanceCreditSpecifications
                  - ec2:DescribeInstanceStatus
                  - ec2:DescribeInstanceTypes
                  - ec2:DescribeInstances
                  - ec2:DescribeInternetGateways
                  - ec2:DescribeKeyPairs
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DescribePlacementGroups
                  - ec2:DescribePrefixLists
                  - ec2:DescribeRouteTables
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSnapshots
                  - ec2:DescribeSubnets
                  - ec2:DescribeTags
                  - ec2:DescribeVolumeAttribute
                  - ec2:DescribeVolumes
                  - ec2:DescribeVolumesModifications
                  - ec2:DescribeVpcAttribute
                  - ec2:DescribeVpcEndpoints
                  - ec2:DescribeVpcs
                  - ec2:DetachNetworkInterface
                  - ec2:DetachVolume
                  - ec2:DisassociateAddress
                  - ec2:GetInstanceUefiData
                  - ec2:ModifyInstanceAttribute
                  - ec2:ModifyInstanceCreditSpecification
                  - ec2:ModifyInstanceMetadataOptions
                  - ec2:ModifyNetworkInterfaceAttribute
                  - ec2:ModifyVolume
                  - ec2:ModifyVolumeAttribute
                  - ec2:RebootInstances
                  - ec2:ReleaseAddress
                  - ec2:RevokeSecurityGroupEgress
                  - ec2:RevokeSecurityGroupIngress
                  - ec2:RunInstances
                  - ec2:StartInstances
                  - ec2:StopInstances
                  - ec2:TerminateInstances
                  - elasticloadbalancing:AddTags
                  - elasticloadbalancing:CreateListener
                  - elasticloadbalancing:CreateLoadBalancer
                  - elasticloadbalancing:CreateTargetGroup
                  - elasticloadbalancing:DeleteListener
                  - elasticloadbalancing:DeleteLoadBalancer
                  - elasticloadbalancing:DeleteTargetGroup
                  - elasticloadbalancing:DeregisterTargets
                  - elasticloadbalancing:DescribeCapacityReservation
                  - elasticloadbalancing:DescribeListenerAttributes
                  - elasticloadbalancing:DescribeListeners
                  - elasticloadbalancing:DescribeLoadBalancerAttributes
                  - elasticloadbalancing:DescribeLoadBalancers
                  - elasticloadbalancing:DescribeTags
                  - elasticloadbalancing:DescribeTargetGroupAttributes
                  - elasticloadbalancing:DescribeTargetGroups
                  - elasticloadbalancing:DescribeTargetHealth
                  - elasticloadbalancing:ModifyListener
                  - elasticloadbalancing:ModifyLoadBalancerAttributes
                  - elasticloadbalancing:ModifyTargetGroup
                  - elasticloadbalancing:ModifyTargetGroupAttributes
                  - elasticloadbalancing:RegisterTargets
                  - elasticloadbalancing:RemoveTags
                  - elasticloadbalancing:SetSecurityGroups
                  - iam:AddRoleToInstanceProfile
                  - iam:AttachRolePolicy
                  - iam:CreateInstanceProfile
                  - iam:CreatePolicy
                  - iam:CreateRole
                  - iam:DeleteInstanceProfile
                  - iam:DeletePolicy
                  - iam:DeleteRole
                  - iam:DeleteRolePolicy
                  - iam:DetachRolePolicy
                  - iam:GetInstanceProfile
                  - iam:GetPolicy
                  - iam:GetPolicyVersion
                  - iam:GetRole
                  - iam:GetRolePolicy
                  - iam:ListAttachedRolePolicies
                  - iam:ListInstanceProfilesForRole
                  - iam:ListPolicyVersions
                  - iam:ListRolePolicies
                  - iam:ListRoleTags
                  - iam:ListRoles
                  - iam:PutRolePolicy
                  - iam:RemoveRoleFromInstanceProfile
                  - iam:TagRole
                  - iam:UntagRole
                  - iam:UpdateAssumeRolePolicy
                  - iam:UpdateRole
                  - kms:CreateGrant
                  - kms:Decrypt
                  - kms:Encrypt
                  - kms:GenerateDataKey
                  - kms:GenerateDataKeyWithoutPlaintext
                  - logs:CreateLogGroup
                  - logs:DeleteLogGroup
                  - logs:DescribeLogGroups
                  - logs:PutRetentionPolicy
                  - logs:TagLogGroup
                  - logs:UntagLogGroup
                  - resource-groups:CreateGroup
                  - resource-groups:DeleteGroup
                  - resource-groups:GetGroup
                  - resource-groups:GetGroupConfiguration
                  - resource-groups:GetGroupQuery
                  - resource-groups:GetTags
                  - resource-groups:Tag
                  - resource-groups:Untag
                  - resource-groups:UpdateGroup
                  - route53:GetHostedZoneCount
                  - route53:ListHostedZones
                  - route53:ListHostedZonesByName
                  - route53resolver:AssociateResolverRule
                  - route53resolver:CreateResolverEndpoint
                  - route53resolver:CreateResolverRule
                  - route53resolver:DeleteResolverEndpoint
                  - route53resolver:DeleteResolverRule
                  - route53resolver:DisassociateResolverRule
                  - route53resolver:GetResolverEndpoint
                  - route53resolver:GetResolverRule
                  - route53resolver:ListResolverEndpoints
                  - route53resolver:ListResolverRules
                  - route53resolver:TagResource
                  - route53resolver:UntagResource
                  - route53resolver:UpdateResolverEndpoint
                  - route53resolver:UpdateResolverRule
                  - ssm:DescribeInstanceInformation
                  - ssm:DescribeParameters
                  - ssm:ListInstanceAssociations
                  - ssm:UpdateInstanceInformation
                  - sts:GetCallerIdentity
                  - tag:GetResources
                Resource: "*"

      Tags:
        - Key: Name
          Value: EC2-SSM-Qumulo-Workshop-Role

  EC2SSMInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2SSMRole
  
  # Private Hosted Zone for Workshop DNS
  QumuloWorkshopPrivateHostedZone:
    Type: AWS::Route53::HostedZone
    Properties:
      Name: qumulo.local
      VPCs:
        - VPCId: !Ref QumuloVPC
          VPCRegion: !Ref AWS::Region
      HostedZoneConfig:
        Comment: "Private hosted zone for Qumulo workshop DNS resolution"
      HostedZoneTags:
        - Key: Name
          Value: qumulo-workshop-private-zone
  
  DefaultInstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Instance SG
      VpcId: !Ref QumuloVPC
      SecurityGroupIngress:
        - IpProtocol: -1
          CidrIp: 10.0.0.0/16
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: instance-default-sg

  # CLEAN: Linux Instance with workshop environment setup
  LinuxInstance:
    Type: AWS::EC2::Instance
    Properties:
      KeyName: !Ref QumuloWorkshopKeyPair
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64}}'
      InstanceType: m5.large
      IamInstanceProfile: !Ref EC2SSMInstanceProfile
      SubnetId: !Ref PrivateSubnetA
      SecurityGroupIds:
        - !Ref DefaultInstanceSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          
          # Log everything for troubleshooting
          exec > >(tee /var/log/user-data.log)
          exec 2>&1
          
          echo "=== UserData script started at $(date) ==="
          
          # Create ssm-user if it doesn't exist (for AL2023)
          if ! id -u ssm-user > /dev/null 2>&1; then
              echo "ssm-user does not exist, creating..."
              useradd -m ssm-user
              echo "ssm-user ALL=(ALL) NOPASSWD:ALL" | tee /etc/sudoers.d/ssm-user
              chmod 440 /etc/sudoers.d/ssm-user
              echo "ssm-user created successfully"
          else
              echo "ssm-user already exists"
          fi
          
          # System updates and SSM
          echo "Updating system packages..."
          dnf update -y
          systemctl enable amazon-ssm-agent
          systemctl start amazon-ssm-agent
          
          # Install essential packages only
          echo "Installing essential packages..."
          dnf install -y --skip-broken wget unzip git vim htop tree jq python3 python3-pip
          
          # Get latest Terraform version and install
          TERRAFORM_VERSION=$(curl -s https://api.releases.hashicorp.com/v1/releases/terraform/latest | jq -r '.version')
          echo "Installing Terraform version: $TERRAFORM_VERSION"
          wget https://releases.hashicorp.com/terraform/$TERRAFORM_VERSION/terraform_$TERRAFORM_VERSION\_linux_amd64.zip
          unzip terraform_$TERRAFORM_VERSION\_linux_amd64.zip
          sudo mv terraform /usr/local/bin/
          rm terraform_$TERRAFORM_VERSION\_linux_amd64.zip
          
          # Verify installation and log version
          terraform version > /var/log/terraform-install.log 2>&1
          echo "Terraform installation completed at $(date)" >> /var/log/terraform-install.log
          
          # Create basic workshop directory structure
          echo "Creating workshop directories..."
          mkdir -p /home/ssm-user/qumulo-workshop
          mkdir -p /home/ssm-user/qumulo-workshop/terraform
          mkdir -p /home/ssm-user/qumulo-workshop/scripts
          mkdir -p /home/ssm-user/qumulo-workshop/logs
          
          # Download workshop content from S3
          echo "Downloading workshop content..."
          aws s3 sync s3://${WorkshopUtilityBucket}/terraform/ /home/ssm-user/qumulo-workshop/terraform/ --region ${AWS::Region}
          aws s3 sync s3://${WorkshopUtilityBucket}/scripts/ /home/ssm-user/qumulo-workshop/scripts/ --region ${AWS::Region}
          
          # Extract any zip files
          cd /home/ssm-user/qumulo-workshop/terraform
          if ls *.zip 1> /dev/null 2>&1; then
              echo "Found zip files, extracting..."
              for zipfile in *.zip; do
                  echo "Processing: $zipfile"
                  unzip -o "$zipfile"
                  # Get the base name without extension
                  BASENAME=$(basename "$zipfile" .zip)
                  if [ -d "$BASENAME" ]; then
                      echo "Moving contents from $BASENAME/ to terraform/"
                      # Move all files and directories
                      find "$BASENAME" -mindepth 1 -maxdepth 1 -exec mv {} . \;
                      # Remove the now-empty directory
                      rmdir "$BASENAME"
                      echo "Successfully extracted and moved contents of $zipfile"
                  else
                      echo "No directory created for $zipfile, files may have been extracted directly"
                  fi
                  rm "$zipfile"
              done
              echo "All zip files processed"
          fi

          
          # Set basic environment
          echo 'export PATH=$PATH:/usr/local/bin' >> /home/ssm-user/.bashrc
          echo 'alias tf=terraform' >> /home/ssm-user/.bashrc
          echo 'cd /home/ssm-user/qumulo-workshop' >> /home/ssm-user/.bashrc
          
          # Set proper ownership
          chown -R ssm-user:ssm-user /home/ssm-user/qumulo-workshop
          chown ssm-user:ssm-user /home/ssm-user/.bashrc

          # Execute the master control script
          echo "Starting workshop control script..."
          if [ -f /home/ssm-user/qumulo-workshop/scripts/workshop-control.sh ]; then
              chmod +x /home/ssm-user/qumulo-workshop/scripts/workshop-control.sh
              sudo /home/ssm-user/qumulo-workshop/scripts/workshop-control.sh
          else
              echo "Warning: workshop-control.sh not found in scripts directory"
          fi
          
          echo "=== UserData script completed at $(date) ==="
      Tags:
        - Key: Name
          Value: qumulo-workshop-linux-instance
    DependsOn: 
      - CopyWorkshopFiles
      - LoadTestingInstance1IdParameter
      - LoadTestingInstance2IdParameter
      - LoadTestingInstance3IdParameter
      - LoadTestingInstance4IdParameter
      - LoadTestingInstance5IdParameter

  WindowsInstance:
    Type: AWS::EC2::Instance
    Properties:
      KeyName: !Ref QumuloWorkshopKeyPair
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-windows-latest/Windows_Server-2025-English-Full-Base}}'
      InstanceType: t3.xlarge
      IamInstanceProfile: !Ref EC2SSMInstanceProfile
      SubnetId: !Ref PrivateSubnetA
      SecurityGroupIds:
        - !Ref DefaultInstanceSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          <powershell>
          # Set execution policy to allow script execution
          Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope LocalMachine -Force
          
          # Set the administrator password
          $NewPassword = "${QumuloEnvironmentPassword}"
          $SecurePassword = ConvertTo-SecureString $NewPassword -AsPlainText -Force
          
          # Get the Administrator account (works with different locales)
          $AdminAccount = Get-LocalUser | Where-Object { $_.SID -like "*-500" }
          
          # Set the password
          $AdminAccount | Set-LocalUser -Password $SecurePassword
          
          # Enable the Administrator account if it's disabled
          $AdminAccount | Enable-LocalUser
          
          # Log the password change
          Write-EventLog -LogName Application -Source "Application" -EventId 1000 -Message "Administrator password has been set for Qumulo workshop"

          # Download and install Chrome silently
          $ChromeInstaller = "$env:TEMP\chrome_installer.exe"
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile $ChromeInstaller
          Start-Process -FilePath $ChromeInstaller -Args "/silent /install" -Verb RunAs -Wait
          Remove-Item $ChromeInstaller
          
          # Wait for Chrome installation to complete
          Start-Sleep -Seconds 10
          
          # Set Chrome as default browser for all users
          $regPath = "HKLM:\SOFTWARE\Microsoft\Windows\Shell\Associations\UrlAssociations\http\UserChoice"
          if (Test-Path $regPath) {
              Remove-Item $regPath -Force -Recurse
          }
          New-Item -Path $regPath -Force
          Set-ItemProperty -Path $regPath -Name "ProgId" -Value "ChromeHTML" -Force
          Set-ItemProperty -Path $regPath -Name "Hash" -Value "A_is_for_Apple" -Force
          
          $regPath = "HKLM:\SOFTWARE\Microsoft\Windows\Shell\Associations\UrlAssociations\https\UserChoice"
          if (Test-Path $regPath) {
              Remove-Item $regPath -Force -Recurse
          }
          New-Item -Path $regPath -Force
          Set-ItemProperty -Path $regPath -Name "ProgId" -Value "ChromeHTML" -Force
          Set-ItemProperty -Path $regPath -Name "Hash" -Value "A_is_for_Apple" -Force
          
          # Set Chrome as default for all file associations
          $associations = @("http", "https", "ftp", ".htm", ".html")
          foreach ($assoc in $associations) {
              cmd /c "assoc $assoc=ChromeHTML" 2>$null
          }
          
          # Configure Chrome to bypass first-run experience and prompts
          $chromePrefsPath = "C:\Program Files\Google\Chrome\Application\master_preferences"
          $chromePrefs = @{
              "homepage" = "about:blank"
              "homepage_is_newtabpage" = $false
              "browser" = @{
                  "show_home_button" = $true
                  "check_default_browser" = $false
              }
              "bookmark_bar" = @{
                  "show_on_all_tabs" = $true
              }
              "distribution" = @{
                  "skip_first_run_ui" = $true
                  "show_welcome_page" = $false
                  "import_search_engine" = $false
                  "import_history" = $false
                  "import_bookmarks" = $false
                  "import_home_page" = $false
                  "do_not_create_any_shortcuts" = $false
                  "do_not_create_taskbar_shortcut" = $false
                  "do_not_create_desktop_shortcut" = $false
                  "do_not_register_for_update_launch" = $false
                  "make_chrome_default" = $true
                  "make_chrome_default_for_user" = $true
              }
              "first_run_tabs" = @("about:blank")
              "sync_promo" = @{
                  "show_on_first_run_allowed" = $false
              }
              "welcome_page_on_os_upgrade_enabled" = $false
          }
          
          $chromePrefs | ConvertTo-Json -Depth 10 | Out-File -FilePath $chromePrefsPath -Encoding UTF8
          
          # Create Chrome policies to suppress additional prompts
          $policyPath = "HKLM:\SOFTWARE\Policies\Google\Chrome"
          if (!(Test-Path $policyPath)) {
              New-Item -Path $policyPath -Force
          }
          
          # Disable Chrome's first-run experience and various prompts
          Set-ItemProperty -Path $policyPath -Name "DefaultBrowserSettingEnabled" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "ImportBookmarks" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "ImportHistory" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "ImportSavedPasswords" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "ImportSearchEngine" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "ImportHomepage" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "MetricsReportingEnabled" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "UserFeedbackAllowed" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "BackgroundModeEnabled" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "BookmarkBarEnabled" -Value 1 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "BrowserSignin" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "SyncDisabled" -Value 1 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "PasswordManagerEnabled" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "AutofillAddressEnabled" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "AutofillCreditCardEnabled" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "TranslateEnabled" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "WelcomePageOnOSUpgradeEnabled" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "PromotionalTabsEnabled" -Value 0 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "ShowHomeButton" -Value 1 -Type DWord
          Set-ItemProperty -Path $policyPath -Name "HomepageLocation" -Value "about:blank" -Type String
          Set-ItemProperty -Path $policyPath -Name "NewTabPageLocation" -Value "about:blank" -Type String
          
          # Disable IE Enhanced Security Configuration
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Active Setup\Installed Components\{A509B1A7-37EF-4b3f-8CFC-4F3A74704073}" -Name "IsInstalled" -Value 0
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Active Setup\Installed Components\{A509B1A8-37EF-4b3f-8CFC-4F3A74704073}" -Name "IsInstalled" -Value 0
          
          # Disable IE first-run prompts
          Set-ItemProperty -Path "HKCU:\Software\Microsoft\Internet Explorer\Main" -Name "DisableFirstRunCustomize" -Value 1
          Set-ItemProperty -Path "HKLM:\Software\Microsoft\Internet Explorer\Main" -Name "DisableFirstRunCustomize" -Value 1
          
          # Create desktop shortcuts
          $WshShell = New-Object -comObject WScript.Shell
          $Shortcut = $WshShell.CreateShortcut("C:\Users\Public\Desktop\Google Chrome.lnk")
          $Shortcut.TargetPath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          $Shortcut.Arguments = "--no-first-run --no-default-browser-check --disable-default-apps --ignore-certificate-errors --ignore-ssl-errors --allow-running-insecure-content"
          $Shortcut.Save()

          # Also remove from Administrator desktop if they exist
          Remove-Item "C:\Users\Administrator\Desktop\EC2 Feedback.url" -Force -ErrorAction SilentlyContinue
          Remove-Item "C:\Users\Administrator\Desktop\EC2 Microsoft Windows Guide.url" -Force -ErrorAction SilentlyContinue
          
          # SSM agent is pre-installed on Windows Server, just ensure it's running
          Start-Service AmazonSSMAgent
          Set-Service AmazonSSMAgent -StartupType Automatic
          
          # Create a desktop shortcut for easy identification
          $WshShell = New-Object -comObject WScript.Shell
          $Shortcut = $WshShell.CreateShortcut("C:\Users\Public\Desktop\Qumulo Workshop.lnk")
          $Shortcut.TargetPath = "notepad.exe"
          $Shortcut.Arguments = "C:\qumulo-workshop-info.txt"
          $Shortcut.Save()

          # Add Qumulo bookmarks to Chrome toolbar
          $bookmarkJson = '[
            {
              "name": "Primary Qumulo",
              "url": "https://demopri.qumulo.local/"
            },
            {
              "name": "Secondary Qumulo", 
              "url": "https://demosec.qumulo.local/"
            }
          ]'

          Set-ItemProperty -Path $policyPath -Name "ManagedBookmarks" -Value $bookmarkJson -Force

          # Fix the array type issue
          $qumuloDomains = [string[]]@(
              "https://demopri.qumulo.local",
              "https://demosec.qumulo.local"
          )


          Write-Host "Qumulo bookmarks and certificate policies configured"


          # Create info file with connection details
          $InfoContent = "Qumulo Workshop Environment`n"
          $InfoContent += "===========================`n"
          $InfoContent += "Administrator Password: ${QumuloEnvironmentPassword}`n"
          $InfoContent += "Instance Type: Windows Server 2025`n"
          $InfoContent += "Workshop Purpose: Qumulo CNQ Deployment`n`n"
          $InfoContent += "Connect via:`n"
          $InfoContent += "- RDP using the Administrator password above`n"
          $InfoContent += "- SSM Session Manager from AWS Console`n"
          $InfoContent | Out-File -FilePath "C:\qumulo-workshop-info.txt" -Encoding UTF8
          </powershell>
      Tags:
        - Key: Name
          Value: qumulo-workshop-windows-instance

  # Load testing instances

  LoadTestingInstance1:
    Type: AWS::EC2::Instance
    Properties:
      KeyName: !Ref QumuloWorkshopKeyPair
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64}}'
      InstanceType: t3.medium
      IamInstanceProfile: !Ref EC2SSMInstanceProfile
      SubnetId: !Ref PrivateSubnetA
      SecurityGroupIds:
        - !Ref DefaultInstanceSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          # Update system
          dnf update -y
          
          # Install load testing tools
          dnf install -y fio stress-ng iperf3 nfs-utils htop tree jq sysstat bc
          
          # Create load testing directories
          mkdir -p /opt/load-testing
          mkdir -p /mnt/qumulo
          mkdir -p /var/log/load-testing
          
          # Set proper permissions
          chmod 777 /var/log/load-testing
          chmod 755 /opt/load-testing
          
          # Signal completion
          echo "Load generator setup completed at $(date)" > /tmp/load-generator-ready
      Tags:
        - Key: Name
          Value: qumulo-load-generator-1

  LoadTestingInstance2:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64}}'
      KeyName: !Ref QumuloWorkshopKeyPair
      InstanceType: t3.medium
      SubnetId: !Ref PrivateSubnetB
      SecurityGroupIds:
        - !Ref DefaultInstanceSecurityGroup
      IamInstanceProfile: !Ref EC2SSMInstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          # Update system
          dnf update -y
          
          # Install load testing tools
          dnf install -y fio stress-ng iperf3 nfs-utils htop tree jq sysstat bc
          
          # Create load testing directories
          mkdir -p /opt/load-testing
          mkdir -p /mnt/qumulo
          mkdir -p /var/log/load-testing
          
          # Set proper permissions
          chmod 777 /var/log/load-testing
          chmod 755 /opt/load-testing
          
          # Signal completion
          echo "Load generator setup completed at $(date)" > /tmp/load-generator-ready
      Tags:
        - Key: Name
          Value: qumulo-load-generator-2

  LoadTestingInstance3:
    Type: AWS::EC2::Instance
    Properties:
      KeyName: !Ref QumuloWorkshopKeyPair
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64}}'
      InstanceType: t3.medium
      SubnetId: !Ref PrivateSubnetC
      SecurityGroupIds:
        - !Ref DefaultInstanceSecurityGroup
      IamInstanceProfile: !Ref EC2SSMInstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          # Update system
          dnf update -y
          
          # Install load testing tools
          dnf install -y fio stress-ng iperf3 nfs-utils htop tree jq sysstat bc
          
          # Create load testing directories
          mkdir -p /opt/load-testing
          mkdir -p /mnt/qumulo
          mkdir -p /var/log/load-testing
          
          # Set proper permissions
          chmod 777 /var/log/load-testing
          chmod 755 /opt/load-testing
          
          # Signal completion
          echo "Load generator setup completed at $(date)" > /tmp/load-generator-ready
      Tags:
        - Key: Name
          Value: qumulo-load-generator-3

  LoadTestingInstance4:
    Type: AWS::EC2::Instance
    Properties:
      KeyName: !Ref QumuloWorkshopKeyPair
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64}}'
      InstanceType: t3.medium
      SubnetId: !Ref PrivateSubnetA
      SecurityGroupIds:
        - !Ref DefaultInstanceSecurityGroup
      IamInstanceProfile: !Ref EC2SSMInstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          # Update system
          dnf update -y
          
          # Install load testing tools
          dnf install -y fio stress-ng iperf3 nfs-utils htop tree jq sysstat bc
          
          # Create load testing directories
          mkdir -p /opt/load-testing
          mkdir -p /mnt/qumulo
          mkdir -p /var/log/load-testing
          
          # Set proper permissions
          chmod 777 /var/log/load-testing
          chmod 755 /opt/load-testing
          
          # Signal completion
          echo "Load generator setup completed at $(date)" > /tmp/load-generator-ready
      Tags:
        - Key: Name
          Value: qumulo-load-generator-4

  LoadTestingInstance5:
    Type: AWS::EC2::Instance
    Properties:
      KeyName: !Ref QumuloWorkshopKeyPair
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64}}'
      InstanceType: t3.medium
      SubnetId: !Ref PrivateSubnetB
      SecurityGroupIds:
        - !Ref DefaultInstanceSecurityGroup
      IamInstanceProfile: !Ref EC2SSMInstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          # Update system
          dnf update -y
          
          # Install load testing tools
          dnf install -y fio stress-ng iperf3 nfs-utils htop tree jq sysstat bc
          
          # Create load testing directories
          mkdir -p /opt/load-testing
          mkdir -p /mnt/qumulo
          mkdir -p /var/log/load-testing
          
          # Set proper permissions
          chmod 777 /var/log/load-testing
          chmod 755 /opt/load-testing
          
          # Signal completion
          echo "Load generator setup completed at $(date)" > /tmp/load-generator-ready
      Tags:
        - Key: Name
          Value: qumulo-load-generator-5

  WorkshopUtilityBucket:
    Type: AWS::S3::Bucket
    Properties:
      #BucketName: !Sub "qumulo-workshop-${AWS::AccountId}-${AWS::Region}-${AWS::StackId}"
      # No BucketName property - AWS will auto-generate a unique name
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

      # Access logging to same bucket
      #LoggingConfiguration:
      #  DestinationBucketName: !Ref WorkshopUtilityBucket
      #  LogFilePrefix: access-logs/

      # Default encryption at rest
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256   # SSE-S3

      LifecycleConfiguration:
        Rules:
          - Id: DeleteAfter7Days
            Status: Enabled
            ExpirationInDays: 7

      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-utility-bucket"

  # Bucket policy allowing Qumulo Lambda to write files
  WorkshopUtilityBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WorkshopUtilityBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowQumuloLambdaAccess
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${QumuloAccountId}:root"
            Action:
              - s3:PutObject
              - s3:PutObjectAcl
              - s3:GetBucketLocation
              - s3:ListBucket
            Resource:
              - !Sub "arn:aws:s3:::${WorkshopUtilityBucket}"      # Bucket ARN
              - !Sub "arn:aws:s3:::${WorkshopUtilityBucket}/*"    # Object ARN
            Condition:
              StringLike:
                "aws:userid": "*:workshop_distribution"

  # Custom resource to invoke Qumulo Lambda function
  CopyWorkshopFiles:
    Type: Custom::CopyFiles
    Properties:
      ServiceToken: !Sub "arn:aws:lambda:${AWS::Region}:${QumuloAccountId}:function:${QumuloLambdaFunctionName}"
      Timeout: 600
      ExternalId: !Ref QumuloExternalId
      DestinationBucket: !Ref WorkshopUtilityBucket
      WorkshopAccountId: !Ref "AWS::AccountId"
    DependsOn: WorkshopUtilityBucketPolicy

  # Parameter Store resources to store CloudFormation variables
  VPCIdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/vpc-id"
      Type: String
      Value: !Ref QumuloVPC
      Description: VPC ID for the workshop

  PrivateSubnetAParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/private-subnet-a"
      Type: String
      Value: !Ref PrivateSubnetA
      Description: Private Subnet A ID

  PrivateSubnetBParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/private-subnet-b"
      Type: String
      Value: !Ref PrivateSubnetB
      Description: Private Subnet B ID

  PrivateSubnetCParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/private-subnet-c"
      Type: String
      Value: !Ref PrivateSubnetC
      Description: Private Subnet C ID

  AWSRegionParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/aws-region"
      Type: String
      Value: !Ref AWS::Region
      Description: AWS Region for the workshop

  DefaultInstanceSecurityGroupParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/default-instance-security-group"
      Type: String
      Value: !Ref DefaultInstanceSecurityGroup
      Description: Default instance security group ID

  WorkshopUtilityBucketParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/utility-bucket-name"
      Type: String
      Value: !Ref WorkshopUtilityBucket
      Description: Workshop utility bucket name

  PrivateKeyIdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/private-key-id"
      Type: String
      Value: !GetAtt QumuloWorkshopKeyPair.KeyPairId
      Description: Private key ID for workshop instances

  StackNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/stack-name"
      Type: String
      Value: !Ref AWS::StackName
      Description: CloudFormation stack name

  AccountIdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/account-id"
      Type: String
      Value: !Ref AWS::AccountId
      Description: AWS Account ID

  QumuloEnvironmentPasswordParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/qumulo-environment-password"
      Type: String
      Value: !Ref QumuloEnvironmentPassword
      Description: Administrator password for Qumulo workshop

  PrivateHostedZoneIdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/private-hosted-zone-id"
      Type: String
      Value: !Ref QumuloWorkshopPrivateHostedZone
      Description: Private hosted zone ID for workshop DNS
  
  LoadTestingInstance1IdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/load-testing-instance-id-1"
      Type: String
      Value: !Ref LoadTestingInstance1
      Description: Load test instance id 1

  LoadTestingInstance2IdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/load-testing-instance-id-2"
      Type: String
      Value: !Ref LoadTestingInstance2
      Description: Load test instance id 2

  LoadTestingInstance3IdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/load-testing-instance-id-3"
      Type: String
      Value: !Ref LoadTestingInstance3
      Description: Load test instance id 3

  LoadTestingInstance4IdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/load-testing-instance-id-4"
      Type: String
      Value: !Ref LoadTestingInstance4
      Description: Load test instance id 4

  LoadTestingInstance5IdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/load-testing-instance-id-5"
      Type: String
      Value: !Ref LoadTestingInstance5
      Description: Load test instance id 5

Outputs:
  VPCId:
    Description: VPC ID for the Qumulo environment
    Value: !Ref QumuloVPC
    Export:
      Name: !Sub "${AWS::StackName}-VPCId"
  
  PrivateSubnetA:
    Description: Private Subnet A ID
    Value: !Ref PrivateSubnetA
    Export:
      Name: !Sub "${AWS::StackName}-PrivateSubnetA"
  
  PrivateSubnetB:
    Description: Private Subnet B ID
    Value: !Ref PrivateSubnetB
    Export:
      Name: !Sub "${AWS::StackName}-PrivateSubnetB"
  
  PrivateSubnetC:
    Description: Private Subnet C ID
    Value: !Ref PrivateSubnetC
    Export:
      Name: !Sub "${AWS::StackName}-PrivateSubnetC"
  
  LinuxInstanceId:
    Description: Linux Instance ID for SSM connection
    Value: !Ref LinuxInstance
    Export:
      Name: !Sub "${AWS::StackName}-LinuxInstanceId"
  
  WindowsInstanceId:
    Description: Windows Instance ID for SSM connection
    Value: !Ref WindowsInstance
    Export:
      Name: !Sub "${AWS::StackName}-WindowsInstanceId"
  
  DefaultInstanceSecurityGroup:
    Description: default security group for workshop instances
    Value: !Ref DefaultInstanceSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-DefaultInstanceSecurityGroup"
  
  WorkshopUtilityBucket:
    Description: S3 bucket containing workshop content
    Value: !Ref WorkshopUtilityBucket
    Export:
      Name: !Sub "${AWS::StackName}-UtilityBucket"
  
  WorkshopContentStatus:
    Description: Status of workshop content copy operation
    Value: !Ref CopyWorkshopFiles
    
  QumuloWorkshopKeyPair:
    Description: Name of the created KeyPair for Qumulo workshop
    Value: !Ref QumuloWorkshopKeyPair
    Export:
      Name: !Sub "${AWS::StackName}-KeyPair"
  
  QumuloWorkshopKeyPairId:
    Description: ID of the created KeyPair (for SSM Parameter Store access)
    Value: !GetAtt QumuloWorkshopKeyPair.KeyPairId
    Export:
      Name: !Sub "${AWS::StackName}-KeyPairId"
  
  PrivateKeySSMParameter:
    Description: SSM Parameter Store path for the private key
    Value: !Sub "/ec2/keypair/${QumuloWorkshopKeyPair.KeyPairId}"
    Export:
      Name: !Sub "${AWS::StackName}-PrivateKeyParameter"
  
  ParameterStorePrefix:
    Description: Parameter Store prefix for all workshop variables
    Value: !Sub "/${AWS::StackName}/"
    Export:
      Name: !Sub "${AWS::StackName}-ParameterPrefix"
  
  VPCIdParameter:
    Description: SSM Parameter Store path for VPC ID
    Value: !Sub "/${AWS::StackName}/vpc-id"
    Export:
      Name: !Sub "${AWS::StackName}-VPCIdParameter"
  
  PrivateSubnetAParameter:
    Description: SSM Parameter Store path for Private Subnet A
    Value: !Sub "/${AWS::StackName}/private-subnet-a"
    Export:
      Name: !Sub "${AWS::StackName}-PrivateSubnetAParameter"
  
  PrivateSubnetBParameter:
    Description: SSM Parameter Store path for Private Subnet B
    Value: !Sub "/${AWS::StackName}/private-subnet-b"
    Export:
      Name: !Sub "${AWS::StackName}-PrivateSubnetBParameter"
  
  PrivateSubnetCParameter:
    Description: SSM Parameter Store path for Private Subnet C
    Value: !Sub "/${AWS::StackName}/private-subnet-c"
    Export:
      Name: !Sub "${AWS::StackName}-PrivateSubnetCParameter"
  
  AWSRegionParameter:
    Description: SSM Parameter Store path for AWS Region
    Value: !Sub "/${AWS::StackName}/aws-region"
    Export:
      Name: !Sub "${AWS::StackName}-AWSRegionParameter"
  
  DefaultInstanceSecurityGroupParameter:
    Description: SSM Parameter Store path for Default Instance Security Group
    Value: !Sub "/${AWS::StackName}/default-instance-security-group"
    Export:
      Name: !Sub "${AWS::StackName}-DefaultInstanceSecurityGroupParameter"
 
  WorkshopUtilityBucketParameter:
    Description: SSM Parameter Store path for Workshop Utility Bucket
    Value: !Sub "/${AWS::StackName}/utility-bucket-name"
    Export:
      Name: !Sub "${AWS::StackName}-WorkshopUtilityBucketParameter"
  
  PrivateKeyIdParameter:
    Description: SSM Parameter Store path for Private Key ID
    Value: !Sub "/${AWS::StackName}/private-key-id"
    Export:
      Name: !Sub "${AWS::StackName}-PrivateKeyIdParameter"
  
  StackNameParameter:
    Description: SSM Parameter Store path for Stack Name
    Value: !Sub "/${AWS::StackName}/stack-name"
    Export:
      Name: !Sub "${AWS::StackName}-StackNameParameter"
  
  AccountIdParameter:
    Description: SSM Parameter Store path for Account ID
    Value: !Sub "/${AWS::StackName}/account-id"
    Export:
      Name: !Sub "${AWS::StackName}-AccountIdParameter"

  PrivateHostedZoneId:
    Description: Private hosted zone ID for workshop DNS
    Value: !Ref QumuloWorkshopPrivateHostedZone
    Export:
      Name: !Sub "${AWS::StackName}-PrivateHostedZoneId"

  LoadTestingInstance1Id:
    Description: Load Testing Instance 1 ID
    Value: !Ref LoadTestingInstance1
    Export:
      Name: !Sub "${AWS::StackName}-LoadTestingInstance1Id"
  
  LoadTestingInstance2Id:
    Description: Load Testing Instance 2 ID
    Value: !Ref LoadTestingInstance2
    Export:
      Name: !Sub "${AWS::StackName}-LoadTestingInstance2Id"

  LoadTestingInstance3Id:
    Description: Load Testing Instance 3 ID
    Value: !Ref LoadTestingInstance3
    Export:
      Name: !Sub "${AWS::StackName}-LoadTestingInstance3Id"

  LoadTestingInstance4Id:
    Description: Load Testing Instance 4 ID
    Value: !Ref LoadTestingInstance4
    Export:
      Name: !Sub "${AWS::StackName}-LoadTestingInstance4Id"

  LoadTestingInstance5Id:
    Description: Load Testing Instance 5 ID
    Value: !Ref LoadTestingInstance5
    Export:
      Name: !Sub "${AWS::StackName}-LoadTestingInstance5Id"

  WorkshopConnectionInstructions:
    Description: Instructions for connecting to workshop instances
    Value: !Sub |
      Connect to instances via AWS Systems Manager Session Manager:
      Linux Instance: ${LinuxInstance}
      Windows Instance: ${WindowsInstance}
      No SSH keys required - use SSM Session Manager in AWS Console